<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= video.title %> - <%= title %></title>
    <!-- SEO Meta -->
    <meta name="description" content="<%= (video.description || video.title).replace(/"/g,'&quot;') %>">
    <% if (typeof canonicalUrl !== 'undefined') { %>
    <link rel="canonical" href="<%= canonicalUrl %>">
    <% } %>

    <!-- Open Graph -->
    <meta property="og:type" content="video.other">
    <meta property="og:title" content="<%= video.title.replace(/"/g,'&quot;') %>">
    <meta property="og:description" content="<%= (video.description || video.title).replace(/"/g,'&quot;') %>">
    <meta property="og:image" content="<%= video.coverUrl || video.thumbnail %>">
    <meta property="og:video" content="<%= video.playUrl || video.streamUrl %>">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="player">
    <meta name="twitter:title" content="<%= video.title.replace(/"/g,'&quot;') %>">
    <meta name="twitter:description" content="<%= (video.description || video.title).replace(/"/g,'&quot;') %>">
    <meta name="twitter:image" content="<%= video.coverUrl || video.thumbnail %>">
    <meta name="twitter:player" content="<%= video.playUrl || video.streamUrl %>">
    <meta name="twitter:player:width" content="1280">
    <meta name="twitter:player:height" content="720">

    <!-- VideoObject JSON-LD -->
    <script type="application/ld+json"><%- JSON.stringify({
      "@context":"https://schema.org",
      "@type":"VideoObject",
      name: video.title,
      description: video.description || video.title,
      thumbnailUrl: video.coverUrl || video.thumbnail,
      uploadDate: new Date(video.createdAt).toISOString(),
      duration: `PT${video.duration}S`,
      embedUrl: video.playUrl || video.streamUrl,
      contentUrl: video.cdnUrl || video.url,
      author:{"@type":"Person",name:video.up.name,identifier:video.up.uid},
      genre: video.category,
      interactionStatistic:[{"@type":"InteractionCounter","interactionType":{"@type":"WatchAction"},"userInteractionCount":video.views||0},{"@type":"InteractionCounter","interactionType":{"@type":"LikeAction"},"userInteractionCount":video.likes||0}],
      isAccessibleForFree: !video.isPremiumOnly
    }) %></script>
    <link rel="stylesheet" href="https://unpkg.com/video.js/dist/video-js.css">
    <link rel="stylesheet" href="https://unpkg.com/@videojs/themes@1/dist/city/index.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .video-player { background: #000; margin-bottom: 20px; }
        .video-info { background: white; padding: 20px; border-radius: 8px; }
        .video-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .video-stats { color: #666; margin-bottom: 15px; }
        .video-description { line-height: 1.6; }
        .uploader-info { display: flex; align-items: center; margin: 15px 0; }
        .uploader-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; margin-right: 10px; }
        .related-videos { margin-top: 20px; }
        .related-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .video-card { background: white; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .video-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .video-thumbnail { width: 100%; height: 120px; background: #ddd; display: flex; align-items: center; justify-content: center; }
        .video-card-info { padding: 10px; }
        .video-card-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .video-card-stats { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <!-- â˜… Video.js æ’­æ”¾å™¨ â˜… -->
        <div style="position: relative; padding-top: 56.25%;" id="playerContainer">
          <video id="videoPlayer" class="video-js vjs-theme-city" playsinline preload="auto" controls controlsList="nodownload" style="position:absolute;top:0;left:0;width:100%;height:100%;background:#000;" oncontextmenu="return false"></video>
         <!-- é®ç½©å±‚ -->
         <div id="payOverlay" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);color:#fff;align-items:center;justify-content:center;flex-direction:column;">
            <p style="font-size:20px;margin-bottom:20px;">è¯•çœ‹å·²ç»“æŸï¼Œæ”¯ä»˜åç»§ç»­è§‚çœ‹</p>
            <button id="buyBtn" style="padding:10px 20px;font-size:16px;cursor:pointer;background:#ff5722;border:none;color:#fff;border-radius:4px;">ç«‹å³è´­ä¹°</button>
          </div>
        </div>
        <!-- â˜… æ’­æ”¾å™¨ç»“æŸ â˜… -->
        
        <div class="video-info">
            <h1 class="video-title"><%= video.title %></h1>
            <div class="video-stats">
                <span><%= video.views || 0 %> æ¬¡æ’­æ”¾</span> â€¢
                <span><%= video.likes || 0 %> ç‚¹èµ</span> â€¢
                <span><%= video.danmakuCount || 0 %> å¼¹å¹•</span>
            </div>
            
            <div class="uploader-info">
                <% if (video.up && video.up.avatarUrl) { %>
                <img src="<%= video.up.avatarUrl %>" alt="<%= (video.up.name || video.up.displayName || video.up.username || 'æœªçŸ¥ç”¨æˆ·') %> çš„å¤´åƒ" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:10px;">
                <% } else { %>
                <div class="uploader-avatar"></div>
                <% } %>
                <div>
                    <div><strong><%= video.up ? (video.up.name || video.up.displayName || video.up.username || 'æœªçŸ¥ç”¨æˆ·') : 'æœªçŸ¥ç”¨æˆ·' %></strong></div>
                    <div style="font-size: 12px; color: #666;">UPä¸»</div>
                </div>
            </div>
            
            <div class="video-description">
                <%= video.description || 'æš‚æ— æè¿°' %>
            </div>
        </div>
        
        <% if (relatedVideos && relatedVideos.length > 0) { %>
        <div class="related-videos">
            <h3 class="related-title">ç›¸å…³æ¨è</h3>
            <div class="video-grid">
                <% relatedVideos.forEach(function(relatedVideo) { %>
                <% const previewAttr = relatedVideo.previewUrl ? `data-preview="${relatedVideo.previewUrl}"` : '' %>
                <% const imgAttr = relatedVideo.previewImage ? `data-image="${relatedVideo.previewImage}"` : '' %>
                <div 
                  class="video-card" 
                  onclick="location.href='/video/<%= relatedVideo._id %>'" 
                >
                    <div class="video-thumbnail" style="position:relative;height:120px;overflow:hidden;" <%- previewAttr %> <%- imgAttr %>>
                        <% const thumb = relatedVideo.previewImage || relatedVideo.coverUrl || relatedVideo.thumbnail || '/api/placeholder/video-thumbnail'; %>
                        <img src="<%= thumb %>" alt="<%= relatedVideo.title %>" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div class="video-card-info">
                        <div class="video-card-title"><%= relatedVideo.title %></div>
                        <div class="video-card-stats">
                            <% if (relatedVideo.up && (relatedVideo.up.name || relatedVideo.up.displayName || relatedVideo.up.username)) { %>
                            <span>ğŸ‘¤ <%= relatedVideo.up.name || relatedVideo.up.displayName || relatedVideo.up.username %></span> Â· 
                            <% } %>
                            <%= relatedVideo.views || 0 %> æ’­æ”¾
                        </div>
                        <% if (relatedVideo.description) { %>
                        <div class="video-card-desc text-muted" style="font-size:12px;line-height:1.4;max-height:3.6em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;"><%= relatedVideo.description %></div>
                        <% } %>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>
        
        <div style="margin-top: 30px; text-align: center;">
            <a href="/" style="color: #1890ff; text-decoration: none;">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>
    <!-- Video.js & æ’ä»¶ -->
    <script src="https://unpkg.com/video.js/dist/video.js"></script>
    <!-- ä½¿ç”¨ jsDelivr CDNï¼Œé¿å… unpkg è¢«é˜»æ–­ -->
    <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-dash@1/dist/videojs-dash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-sprite-thumbnails@latest/dist/videojs-sprite-thumbnails.min.js"></script>

    <!-- ç›¸å…³è§†é¢‘æ•°æ® -->
    <script id="related-videos-data" type="application/json">
      <%- JSON.stringify(relatedVideos || []) %>
    </script>

    <!-- é¡µé¢é…ç½®æ•°æ®ï¼Œé¿å…åœ¨JSä¸­ç›´æ¥å†™EJSï¼Œå‡å°‘è¯­æ³•å†²çª -->
    <script id="page-config" type="application/json">
      <%- JSON.stringify({
        VIDEO_ID: video.id,
        PRICE: Number.isFinite(video.priceCoins) ? video.priceCoins : 0,
        CATEGORY: video.category,
        DEFAULT_PLAY_URL: video.playUrl ? video.playUrl : '',
        IS_LOGIN: !!user
      }) %>
    </script>

    <script>
      const PAGE_CONF = JSON.parse(document.getElementById('page-config').textContent || '{}');
      const VIDEO_ID = PAGE_CONF.VIDEO_ID;
      const PRICE    = PAGE_CONF.PRICE;
      const IS_PAID_VIDEO = (PRICE > 0) || (PAGE_CONF.CATEGORY && PAGE_CONF.CATEGORY.trim() === 'paid');
      const DEFAULT_PLAY_URL = PAGE_CONF.DEFAULT_PLAY_URL;
      const IS_LOGIN = PAGE_CONF.IS_LOGIN;
      let hasPurchase = false; // åç«¯å¯æ¸²æŸ“å·²è´­çŠ¶æ€

      const playerEl   = document.getElementById('videoPlayer');
      const vjsPlayer  = videojs(playerEl, {
        fluid: true,
        html5:{ vhs:{ overrideNative:true }},
        controlBar:{ pictureInPictureToggle:false, downloadMenuButton:false }
      });

      // ç¼©ç•¥å›¾ç¤ºä¾‹ï¼ˆæ’ä»¶å­˜åœ¨æ—¶æ‰è°ƒç”¨ï¼‰
      if (typeof vjsPlayer.spriteThumbnails === 'function') {
        try {
          vjsPlayer.spriteThumbnails({ url:'/thumbs/sprite.jpg', width:160, height:90, interval:1 });
        } catch(e) { console.warn('spriteThumbnails åˆå§‹åŒ–å¤±è´¥', e); }
      }

      const overlay  = document.getElementById('payOverlay');
      const buyBtn   = document.getElementById('buyBtn');

      const PREVIEW_SECONDS = 30;

      // è¿½è¸ªé¢„è§ˆåª’ä»‹ï¼ˆvideo æˆ– iframeï¼‰
      let previewIsIframe = false;
      let previewIframe   = null;

      function showPayOverlay(){
        overlay.style.display = 'flex';
        if(previewIsIframe && previewIframe){
          // åœæ­¢ iframe æ’­æ”¾
          previewIframe.remove();
          previewIframe = null;
        }else{
          vjsPlayer.pause();
        }
      }

      // ç›‘å¬è¯•çœ‹é™åˆ¶ï¼ˆVideo.jsï¼‰
      vjsPlayer.on('timeupdate', ()=>{
        if(IS_PAID_VIDEO && !hasPurchase && vjsPlayer.currentTime() >= PREVIEW_SECONDS){
          showPayOverlay();
        }
      });

      // è¯•çœ‹è®¡æ—¶å™¨
      let previewTimer = null;
      function startPreviewCountdown(){
        if(previewTimer){ clearTimeout(previewTimer); }
        if(IS_PAID_VIDEO && !hasPurchase){
          previewTimer = setTimeout(()=>{
            showPayOverlay();
          }, PREVIEW_SECONDS * 1000);
        }
      }

      // å½“ HTML5 è§†é¢‘çœŸæ­£å¼€å§‹æ’­æ”¾åå†å¯åŠ¨è®¡æ—¶ï¼Œé¿å…ç”¨æˆ·æœªç‚¹å‡»æ’­æ”¾è®¡æ—¶å…ˆç»“æŸ
      vjsPlayer.on('play', ()=>{
        if(!previewIsIframe){
          startPreviewCountdown();
        }
      });

      async function getPreviewUrl(){
        const res = await fetch(`/api/video/${VIDEO_ID}/preview`);
        const j   = await res.json();
        return j.data.url;
      }

      async function getPlayUrl(){
        const res = await fetch(`/api/video/${VIDEO_ID}/play`,{
          headers:{ 'Authorization':'Bearer '+ (localStorage.authToken||'') }
        });
        if(res.status===403){
          return null; // æœªè´­ä¹°
        }
        const j = await res.json();
        return j.data && j.data.url;
      }

      function loadSource(url){
        if(url.includes('iframe.mediadelivery.net/embed')){
          const container = document.getElementById('playerContainer');
          // åˆ›å»ºå¹¶æ’å…¥ iframeï¼Œè€Œä¸æ›¿æ¢æ•´ä¸ªå®¹å™¨ï¼Œä»¥ä¿ç•™é®ç½©å±‚
          const iframe = document.createElement('iframe');
          iframe.src = url;
          iframe.allow = 'accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture';
          iframe.allowFullscreen = true;
          iframe.style.position = 'absolute';
          iframe.style.top = '0';
          iframe.style.left = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';

          // éšè—åŸç”Ÿ video å…ƒç´ ï¼Œé¿å…åŒæ—¶æ’­æ”¾
          playerEl.style.display = 'none';

          // å…ˆæ’å…¥ iframeï¼Œå†æŠŠ overlay ç½®äºæœ€ä¸Šå±‚
          container.appendChild(iframe);
          overlay.style.zIndex = '9999';
          container.appendChild(overlay);

          // è®°å½•çŠ¶æ€
          previewIsIframe = true;
          previewIframe   = iframe;

          // å¼€å§‹ iframe è¯•çœ‹è®¡æ—¶
          startPreviewCountdown();
          return;
        }

        const isHls = url.includes('.m3u8');
        const isDash = url.endsWith('.mpd');
        if(isDash){
          vjsPlayer.src({ src:url, type:'application/dash+xml' });
        }else if(isHls){
          vjsPlayer.src({ src:url, type:'application/x-mpegURL' });
        }else{
          vjsPlayer.src({ src:url, type:'video/mp4' });
        }
      }

      async function unlockVideo(){
        const res = await fetch(`/api/unlock/${VIDEO_ID}`,{
          method:'POST',
          headers:{
            'Authorization':'Bearer '+(localStorage.authToken||''),
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ hoursValid: 72 })
        });
        const j = await res.json();
        return j.iframe; // å­—æ®µåä¸º iframe
      }

      async function init(){
        let url;

        if(IS_PAID_VIDEO){
          url = await getPlayUrl();
          if(!url){
            url = await getPreviewUrl();
          }
        }else{
          url = DEFAULT_PLAY_URL;
        }

        loadSource(url);
        // å…ƒæ•°æ®åŠ è½½åè‡ªåŠ¨æ’­æ”¾é™éŸ³
        vjsPlayer.ready(()=>{
          if(!IS_PAID_VIDEO){
            vjsPlayer.muted(true);
            vjsPlayer.play().catch(()=>{});
          }
        });
      }

      buyBtn.addEventListener('click', async ()=>{
        if(!IS_LOGIN){ alert('è¯·å…ˆç™»å½•'); return; }
        try{
          const iframeUrl = await unlockVideo();
          if(iframeUrl){
            hasPurchase = true;
            if(previewTimer){ clearTimeout(previewTimer); previewTimer = null; }
            if(previewIsIframe && previewIframe){ previewIframe.remove(); previewIframe = null; }
            overlay.style.display = 'none';

            const finalUrl = iframeUrl.includes('?') ? `${iframeUrl}&autoplay=true&muted=false&playsinline=true` : `${iframeUrl}?autoplay=true&muted=false&playsinline=true`;

            const container = document.getElementById('playerContainer');
            container.innerHTML = '';
            playerEl.style.display = 'none';
            previewIsIframe = false;
            loadSource(finalUrl);
          }else{
            alert('è§£é”å¤±è´¥');
          }
        }catch(e){ console.error(e); alert('è´­ä¹°å¤±è´¥'); }
      });

      init();

      // å¼•å…¥è§†é¢‘é¢„è§ˆå¤„ç†è„šæœ¬ - ç›´æ¥å¤åˆ¶ä¸»é¡µçš„é€»è¾‘
      document.addEventListener('DOMContentLoaded', () => {
        // é¦–å…ˆä¸ºç›¸å…³æ¨èè§†é¢‘å¡ç‰‡è®¾ç½®__data__å±æ€§
        const relatedVideosData = JSON.parse(document.getElementById('related-videos-data').textContent || '[]');
        const videoCards = document.querySelectorAll('.video-card');
        videoCards.forEach((card, index) => {
          if (relatedVideosData[index]) {
            card.__data__ = relatedVideosData[index];
          }
        });

        function applyPreviewAnimation(){
          document.querySelectorAll('.video-card').forEach(card => {
            const videoData = card.__data__ || {};
            const img = card.querySelector('.video-thumbnail img');
            if(!img) return;

            const thumbDiv = card.querySelector('.video-thumbnail');
            let p = thumbDiv?.dataset.preview || (videoData && videoData.previewUrl) || '';
            const imgFallback = thumbDiv?.dataset.image || (videoData && videoData.previewImage) || '';
            if(!p) return;

            if(/\.(mp4|webm)$/i.test(p)){
              const v = document.createElement('video');
              v.muted = true;
              v.loop = true;
              v.autoplay = true;
              v.playsInline = true;
              v.setAttribute('playsinline','');
              v.setAttribute('webkit-playsinline','');
              v.setAttribute('muted','');
              v.style.width = '100%';
              v.style.height = '100%';
              v.style.objectFit = 'cover';
              v.style.background = 'transparent';

              // å°è¯• webm ä¸ mp4 åŒæº
              const source1 = document.createElement('source');
              source1.src = p;
              source1.type = p.endsWith('.webm') ? 'video/webm' : 'video/mp4';
              const alt = p.endsWith('.webm') ? p.replace('.webm','.mp4') : p.replace('.mp4','.webm');
              const source2 = document.createElement('source');
              source2.src = alt;
              source2.type = alt.endsWith('.webm') ? 'video/webm' : 'video/mp4';
              v.appendChild(source1);
              v.appendChild(source2);
              v.src = p; // è®¾ç½®é¦–é€‰æºï¼ŒSafari éœ€è¦

              // å‡ºé”™æ—¶å›é€€åˆ°å›¾ç‰‡
              v.onerror = ()=>{ if(imgFallback){ img.src = imgFallback; }
              };

              img.replaceWith(v);
            }else{
              img.src = p;
            }
          });
        }

        applyPreviewAnimation();
      });
    </script>
</body>
</html>