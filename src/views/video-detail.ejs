<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="referrer" content="origin-when-cross-origin">
    <title><%= video.title %> - <%= title %></title>
    <!-- Umami Analytics -->
    <script defer src="https://cloud.umami.is/script.js" data-website-id="0447789b-3880-4f93-bcc4-e0c5db71972d"></script>
    <!-- SEO Meta -->
    <meta name="description" content="<%= (video.description || video.title).replace(/"/g,'&quot;') %>">
    <% if (typeof canonicalUrl !== 'undefined') { %>
    <link rel="canonical" href="<%= canonicalUrl %>">
    <% } %>

    <!-- Open Graph -->
    <meta property="og:type" content="video.other">
    <meta property="og:title" content="<%= video.title.replace(/"/g,'&quot;') %>">
    <meta property="og:description" content="<%= (video.description || video.title).replace(/"/g,'&quot;') %>">
    <meta property="og:image" content="<%= video.coverUrl || video.thumbnail %>">
    <!-- æ¢å¤ç¤¾äº¤å¡ç‰‡å¯ç”¨æ€§ï¼ˆä¸æ”¾ç­¾åç›´é“¾ï¼Œä¿æŒå…¼å®¹ï¼‰ -->
    <meta property="og:video" content="<%= canonicalUrl %>">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="player">
    <meta name="twitter:title" content="<%= video.title.replace(/"/g,'&quot;') %>">
    <meta name="twitter:description" content="<%= (video.description || video.title).replace(/"/g,'&quot;') %>">
    <meta name="twitter:image" content="<%= video.coverUrl || video.thumbnail %>">
    <meta name="twitter:player" content="<%= canonicalUrl %>">
    <meta name="twitter:player:width" content="1280">
    <meta name="twitter:player:height" content="720">

    <!-- VideoObject JSON-LD -->
    <script type="application/ld+json"><%- JSON.stringify({
      "@context":"https://schema.org",
      "@type":"VideoObject",
      name: video.title,
      description: video.description || video.title,
      thumbnailUrl: video.coverUrl || video.thumbnail,
      uploadDate: new Date(video.createdAt).toISOString(),
      duration: `PT${video.duration}S`,
      // é¿å…åœ¨ç»“æ„åŒ–æ•°æ®ä¸­æš´éœ²ç›´é“¾
      embedUrl: canonicalUrl,
      contentUrl: canonicalUrl,
      author:{"@type":"Person",name:video.up.name,identifier:video.up.uid},
      genre: video.category,
      interactionStatistic:[{"@type":"InteractionCounter","interactionType":{"@type":"WatchAction"},"userInteractionCount":video.views||0},{"@type":"InteractionCounter","interactionType":{"@type":"LikeAction"},"userInteractionCount":video.likes||0}],
      isAccessibleForFree: !video.isPremiumOnly
    }) %></script>
    <link rel="stylesheet" href="https://unpkg.com/video.js/dist/video-js.css">
    <link rel="stylesheet" href="https://unpkg.com/@videojs/themes@1/dist/city/index.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .video-player { background: #000; margin-bottom: 20px; }
        .video-info { background: white; padding: 20px; border-radius: 8px; }
        .video-title { font-size: 24px; font-weight: bold; margin-bottom: 10px; }
        .video-stats { color: #666; margin-bottom: 15px; }
        .video-description { line-height: 1.6; }
        .uploader-info { display: flex; align-items: center; margin: 15px 0; }
        .uploader-avatar { width: 40px; height: 40px; border-radius: 50%; background: #ddd; margin-right: 10px; }
        .related-videos { margin-top: 20px; }
        .related-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .video-card { background: white; border-radius: 8px; overflow: hidden; cursor: pointer; }
        .video-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .video-thumbnail { width: 100%; height: 120px; background: #ddd; display: flex; align-items: center; justify-content: center; }
        .video-card-info { padding: 10px; }
        .video-card-title { font-size: 14px; font-weight: bold; margin-bottom: 5px; }
        .video-card-stats { font-size: 12px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <!-- â˜… Video.js æ’­æ”¾å™¨ â˜… -->
        <div style="position: relative; padding-top: 56.25%;" id="playerContainer">
          <video id="videoPlayer" class="video-js vjs-theme-city" playsinline preload="auto" controls controlsList="nodownload" style="position:absolute;top:0;left:0;width:100%;height:100%;background:#000;" oncontextmenu="return false"></video>
         <!-- é®ç½©å±‚ -->
         <div id="payOverlay" style="display:none;position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);color:#fff;align-items:center;justify-content:center;flex-direction:column;">
            <p style="font-size:20px;margin-bottom:20px;">è¯•çœ‹å·²ç»“æŸï¼Œæ”¯ä»˜åç»§ç»­è§‚çœ‹</p>
            <button id="buyBtn" style="padding:10px 20px;font-size:16px;cursor:pointer;background:#ff5722;border:none;color:#fff;border-radius:4px;">ç«‹å³è´­ä¹°</button>
          </div>
        </div>
        <!-- â˜… æ’­æ”¾å™¨ç»“æŸ â˜… -->
        
        <div class="video-info">
            <h1 class="video-title"><%= video.title %></h1>
            <div class="video-stats">
                <span><%= video.views || 0 %> æ¬¡æ’­æ”¾</span> â€¢
                <span><%= video.likes || 0 %> ç‚¹èµ</span> â€¢
                <span><%= video.danmakuCount || 0 %> å¼¹å¹•</span>
            </div>
            
            <div class="uploader-info">
                <% if (video.up && video.up.avatarUrl) { %>
                <img src="<%= video.up.avatarUrl %>" alt="<%= (video.up.name || video.up.displayName || video.up.username || 'æœªçŸ¥ç”¨æˆ·') %> çš„å¤´åƒ" style="width:40px;height:40px;border-radius:50%;object-fit:cover;margin-right:10px;">
                <% } else { %>
                <div class="uploader-avatar"></div>
                <% } %>
                <div>
                    <div><strong><%= video.up ? (video.up.name || video.up.displayName || video.up.username || 'æœªçŸ¥ç”¨æˆ·') : 'æœªçŸ¥ç”¨æˆ·' %></strong></div>
                    <div style="font-size: 12px; color: #666;">UPä¸»</div>
                </div>
            </div>
            
            <div class="video-description">
                <%= video.description || 'æš‚æ— æè¿°' %>
            </div>
        </div>
        
        <% if (relatedVideos && relatedVideos.length > 0) { %>
        <div class="related-videos">
            <h3 class="related-title">ç›¸å…³æ¨è</h3>
            <div class="video-grid">
                <% relatedVideos.forEach(function(relatedVideo) { %>
                <% const previewAttr = relatedVideo.previewUrl ? `data-preview="${relatedVideo.previewUrl}"` : '' %>
                <% const imgAttr = relatedVideo.previewImage ? `data-image="${relatedVideo.previewImage}"` : '' %>
                <div 
                  class="video-card" 
                  onclick="location.href='/video/<%= relatedVideo._id %>'" 
                >
                    <div class="video-thumbnail" style="position:relative;height:120px;overflow:hidden;" <%- previewAttr %> <%- imgAttr %>>
                        <% const thumb = relatedVideo.previewImage || relatedVideo.coverUrl || relatedVideo.thumbnail || '/api/placeholder/video-thumbnail'; %>
                        <img src="<%= thumb %>" alt="<%= relatedVideo.title %>" style="width:100%;height:100%;object-fit:cover;">
                    </div>
                    <div class="video-card-info">
                        <div class="video-card-title"><%= relatedVideo.title %></div>
                        <div class="video-card-stats">
                            <% if (relatedVideo.up && (relatedVideo.up.name || relatedVideo.up.displayName || relatedVideo.up.username)) { %>
                            <span>ğŸ‘¤ <%= relatedVideo.up.name || relatedVideo.up.displayName || relatedVideo.up.username %></span> Â· 
                            <% } %>
                            <%= relatedVideo.views || 0 %> æ’­æ”¾
                        </div>
                        <% if (relatedVideo.description) { %>
                        <div class="video-card-desc text-muted" style="font-size:12px;line-height:1.4;max-height:3.6em;overflow:hidden;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;"><%= relatedVideo.description %></div>
                        <% } %>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
        <% } %>
        
        <div style="margin-top: 30px; text-align: center;">
            <a href="/" style="color: #1890ff; text-decoration: none;">â† è¿”å›é¦–é¡µ</a>
        </div>
    </div>
    <!-- Video.js & æ’ä»¶ -->
    <script src="https://unpkg.com/video.js/dist/video.js"></script>
    <!-- ä½¿ç”¨ jsDelivr CDNï¼Œé¿å… unpkg è¢«é˜»æ–­ -->
    <script src="https://cdn.jsdelivr.net/npm/videojs-contrib-dash@1/dist/videojs-dash.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/videojs-sprite-thumbnails@latest/dist/videojs-sprite-thumbnails.min.js"></script>

    <!-- ç›¸å…³è§†é¢‘æ•°æ® -->
    <script id="related-videos-data" type="application/json">
      <%- JSON.stringify(relatedVideos || []) %>
    </script>

    <!-- é¡µé¢é…ç½®æ•°æ®ï¼Œé¿å…åœ¨JSä¸­ç›´æ¥å†™EJSï¼Œå‡å°‘è¯­æ³•å†²çª -->
    <script id="page-config" type="application/json">
      <%- JSON.stringify({
        VIDEO_ID: video.id,
        PRICE: Number.isFinite(video.priceCoins) ? video.priceCoins : 0,
        CATEGORY: video.category,
        DEFAULT_PLAY_URL: video.playUrl ? video.playUrl : '',
        IS_LOGIN: !!user,
        IS_PREMIUM_USER: (typeof user !== 'undefined' && user && user.isPremium === true) ? true : false,
        VIDEO_IS_PREMIUM_ONLY: !!video.isPremiumOnly
      }) %>
    </script>

    <script>
      const PAGE_CONF = JSON.parse(document.getElementById('page-config').textContent || '{}');

      // å‰ç«¯ UA ç™½åå•ï¼šPC Chromeã€Android Chromeã€iOS Safariã€iOS Chromeï¼ˆCriOSï¼‰
      (function enforceUA(){
        try{
          const ua = (navigator.userAgent||'').toLowerCase();
          const isIOS = /iphone|ipad|ipod/.test(ua);
          const isAndroid = /android/.test(ua);
          const isDesktop = !isIOS && !isAndroid;
          const blocked = /edg|edgios|edga|opr|opios|firefox|fxios|ucbrowser|samsungbrowser|huawei|harmony|miuibrowser|baidubrowser|bidubrowser|qqbrowser|dingtalk|micromessenger/.test(ua);
          let allowed = false;
          if(!blocked){
            if(isIOS){
              const isCriOS = /crios/.test(ua);
              const isSafari = /safari/.test(ua) && /version\//.test(ua) && !isCriOS;
              allowed = isSafari || isCriOS;
            } else if(isAndroid){
              allowed = /chrome\//.test(ua);
            } else if(isDesktop){
              allowed = /chrome\//.test(ua);
            }
          }
          if(!allowed){
            // æ‹’ç»åˆå§‹åŒ– Video.js
            const container = document.getElementById('playerContainer');
            if(container){
              container.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:220px;background:#111;color:#fff;border-radius:8px;">å½“å‰æµè§ˆå™¨ä¸è¢«æ”¯æŒï¼Œè¯·ä½¿ç”¨ PC Chromeã€Android Chrome æˆ– iOS Safari/Chrome</div>';
            }
            throw new Error('Blocked UA');
          }
        }catch(e){ console.warn('UA blocked or check failed:', e && e.message); }
      })();
      
      const VIDEO_ID = PAGE_CONF.VIDEO_ID;
      const PRICE    = PAGE_CONF.PRICE;
      let hasPurchase = false; // åç«¯å¯æ¸²æŸ“å·²è´­çŠ¶æ€
      const IS_PAID_VIDEO = (PRICE > 0) || (PAGE_CONF.CATEGORY && PAGE_CONF.CATEGORY.trim() === 'paid');
      const IS_VIP_VIDEO = PAGE_CONF.VIDEO_IS_PREMIUM_ONLY;
      const IS_PREMIUM_USER = PAGE_CONF.IS_PREMIUM_USER;

      // æ­£å¸¸æ¨¡å¼ï¼šæ ¹æ®æ•°æ®åº“ä¸­çš„isPremiumOnlyå­—æ®µåˆ¤æ–­æ˜¯å¦ä¸ºä¼šå‘˜è§†é¢‘
      const FORCE_VIP_TEST = false; // ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºfalse
      console.log('=== ä¼šå‘˜è§†é¢‘æµ‹è¯•æ¨¡å¼ ===');
      console.log('åŸå§‹ IS_VIP_VIDEO:', IS_VIP_VIDEO);
      console.log('IS_PREMIUM_USER:', IS_PREMIUM_USER);
      console.log('å¼ºåˆ¶æµ‹è¯•æ¨¡å¼:', FORCE_VIP_TEST);

      // è®¡ç®—æ˜¯å¦éœ€è¦è¯•çœ‹é™åˆ¶ï¼ˆå®æ—¶è®¡ç®—ï¼Œè´­ä¹°/å¼€é€šä¼šå‘˜åå¯åŠ¨æ€å˜åŒ–ï¼‰
      const needRestrict = () => {
        const result = (IS_PAID_VIDEO && !hasPurchase) || ((IS_VIP_VIDEO || FORCE_VIP_TEST) && !IS_PREMIUM_USER);
        console.log('needRestrict() è®¡ç®—ç»“æœ:', result, {
          IS_PAID_VIDEO,
          hasPurchase,
          IS_VIP_VIDEO: IS_VIP_VIDEO || FORCE_VIP_TEST,
          IS_PREMIUM_USER
        });
        return result;
      };

      const DEFAULT_PLAY_URL = PAGE_CONF.DEFAULT_PLAY_URL;
      const IS_LOGIN = PAGE_CONF.IS_LOGIN;

      const playerEl   = document.getElementById('videoPlayer');
      const vjsPlayer  = videojs(playerEl, {
        fluid: true,
        html5:{ vhs:{ overrideNative:true }},
        controlBar:{ pictureInPictureToggle:false, downloadMenuButton:false }
      });

      // ç¼©ç•¥å›¾ç¤ºä¾‹ï¼ˆæ’ä»¶å­˜åœ¨æ—¶æ‰è°ƒç”¨ï¼‰
      if (typeof vjsPlayer.spriteThumbnails === 'function') {
        try {
      vjsPlayer.spriteThumbnails({ url:'/thumbs/sprite.jpg', width:160, height:90, interval:1 });
        } catch(e) { console.warn('spriteThumbnails åˆå§‹åŒ–å¤±è´¥', e); }
      }

      const overlay  = document.getElementById('payOverlay');
      const buyBtn   = document.getElementById('buyBtn');

      console.log('åˆå§‹åŒ–å…ƒç´ æ£€æŸ¥:');
      console.log('overlay:', overlay);
      console.log('buyBtn:', buyBtn);

      // æ ¹æ®è§†é¢‘ç±»å‹åŠ¨æ€ä¿®æ”¹æç¤ºæ–‡æ¡ˆ
      if((IS_VIP_VIDEO || FORCE_VIP_TEST) && !IS_PREMIUM_USER){
        if(overlay && overlay.querySelector('p')) {
          overlay.querySelector('p').textContent = 'è¯•çœ‹å·²ç»“æŸï¼Œè¯·å¼€é€šä¼šå‘˜ç»§ç»­è§‚çœ‹';
          console.log('âœ… å·²è®¾ç½®ä¼šå‘˜æç¤ºæ–‡æ¡ˆ');
        }
        if(buyBtn) {
          buyBtn.textContent = 'ç«‹å³å¼€é€šä¼šå‘˜';
          console.log('âœ… å·²è®¾ç½®ä¼šå‘˜æŒ‰é’®æ–‡æ¡ˆ');
        }
      }

      const PREVIEW_SECONDS = 150;

      // è¿½è¸ªé¢„è§ˆåª’ä»‹ï¼ˆvideo æˆ– iframeï¼‰
      let previewIsIframe = false;
      let previewIframe   = null;

      let overlayShown = false; // é˜²æ­¢é‡å¤æ˜¾ç¤ºé®ç½©
      
      function showPayOverlay(){
        if(overlayShown) {
          console.log('âš ï¸ é®ç½©å·²ç»æ˜¾ç¤ºè¿‡äº†ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
          return;
        }
        
        console.log('ğŸš€ æ‰§è¡ŒshowPayOverlayï¼Œæ˜¾ç¤ºé®ç½©å±‚');
        overlayShown = true;
        
        // æ¸…ç†æ‰€æœ‰è®¡æ—¶å™¨
        if(previewTimer) {
          clearTimeout(previewTimer);
          previewTimer = null;
          console.log('ğŸ§¹ æ¸…ç†previewTimer');
        }
        if(forceCheckTimer) {
          clearInterval(forceCheckTimer);
          forceCheckTimer = null;
          console.log('ğŸ§¹ æ¸…ç†forceCheckTimer');
        }
        
        // ç›´æ¥é€šè¿‡IDè·å–å…ƒç´ ï¼Œç¡®ä¿è·å–åˆ°æœ€æ–°çš„DOM
        const overlayElement = document.getElementById('payOverlay');
        console.log('ğŸ” overlayå…ƒç´ :', overlayElement);
        
        if (!overlayElement) {
          console.error('âŒ overlayå…ƒç´ æœªæ‰¾åˆ°ï¼');
          return;
        }
        
        overlayElement.style.display = 'flex';
        overlayElement.style.zIndex = '9999';
        overlayElement.style.position = 'absolute';
        console.log('âœ… é®ç½©å±‚æ ·å¼å·²è®¾ç½®');
        console.log('ğŸ“Š å½“å‰overlayæ ·å¼:', {
          display: overlayElement.style.display,
          zIndex: overlayElement.style.zIndex,
          position: overlayElement.style.position
        });
        
        if(previewIsIframe && previewIframe){
          // åœæ­¢ iframe æ’­æ”¾
          console.log('ğŸ›‘ ç§»é™¤iframeæ’­æ”¾å™¨');
          previewIframe.remove();
          previewIframe = null;
        }else{
          console.log('â¸ï¸ æš‚åœVideo.jsæ’­æ”¾å™¨');
          try {
            vjsPlayer.pause();
          } catch(e) {
            console.error('âŒ æš‚åœæ’­æ”¾å™¨å¤±è´¥:', e);
          }
        }
      }

      // ç›‘å¬è¯•çœ‹é™åˆ¶ï¼ˆVideo.jsï¼‰- é˜²æ­¢ç”¨æˆ·è·³è·ƒæ’­æ”¾ç»•è¿‡é™åˆ¶
      let totalWatchedTime = 0;
      let lastCheckTime = 0;
      
      vjsPlayer.on('timeupdate', ()=>{
        const currentTime = vjsPlayer.currentTime();
        
        // è®¡ç®—å®é™…è§‚çœ‹æ—¶é—´ï¼Œé˜²æ­¢ç”¨æˆ·è·³è·ƒæ’­æ”¾
        if(needRestrict()) {
          const timeDiff = currentTime - lastCheckTime;
          // åªæœ‰è¿ç»­æ’­æ”¾æ—¶æ‰ç´¯è®¡è§‚çœ‹æ—¶é—´ï¼ˆæ—¶é—´å·®å°äº2ç§’ä¸”ä¸ºæ­£æ•°ï¼‰
          if(timeDiff > 0 && timeDiff <= 2) {
            totalWatchedTime += timeDiff;
          }
          lastCheckTime = currentTime;
          
          // è°ƒè¯•ä¿¡æ¯
          if(currentTime > 120 && Math.floor(currentTime) % 5 === 0) {
            console.log(`æ’­æ”¾æ—¶é—´: ${currentTime.toFixed(1)}s, å®é™…è§‚çœ‹: ${totalWatchedTime.toFixed(1)}s, PREVIEW_SECONDS: ${PREVIEW_SECONDS}`);
          }
          
          // æ£€æŸ¥æ˜¯å¦è¾¾åˆ°é™åˆ¶æ¡ä»¶ï¼ˆä»»ä¸€æ¡ä»¶æ»¡è¶³éƒ½ä¼šè§¦å‘ï¼‰
          if(currentTime >= PREVIEW_SECONDS || totalWatchedTime >= PREVIEW_SECONDS){
            console.log('è§¦å‘è¯•çœ‹é™åˆ¶ - æ’­æ”¾æ—¶é—´:', currentTime.toFixed(1), 's, è§‚çœ‹æ—¶é—´:', totalWatchedTime.toFixed(1), 's');
            showPayOverlay();
          }
        }
      });

      // è¯•çœ‹è®¡æ—¶å™¨ - åŒºåˆ†iframeå’ŒVideo.jsä¸¤ç§æ’­æ”¾å™¨
      let forceCheckTimer = null;
      let previewTimer = null;
      let previewStarted = false;
      
      function startPreviewCountdown(){
        if(forceCheckTimer){ clearInterval(forceCheckTimer); forceCheckTimer = null; }
        if(previewTimer){ clearTimeout(previewTimer); previewTimer = null; }
        
        if(needRestrict() && !previewStarted){
          console.log('âœ… æ»¡è¶³å¯åŠ¨é¢„è§ˆé™åˆ¶çš„æ¡ä»¶');
          previewStarted = true;
          
          if(previewIsIframe) {
            // å¯¹äºiframeæ’­æ”¾å™¨ï¼Œä½¿ç”¨åŸºäºå®é™…æ—¶é—´çš„è®¡æ—¶å™¨ï¼ˆå› ä¸ºæ— æ³•ç›‘å¬è·¨åŸŸiframeå†…éƒ¨äº‹ä»¶ï¼‰
            console.log(`ğŸ¬ iframeæ’­æ”¾å™¨å¯åŠ¨${PREVIEW_SECONDS}ç§’é¢„è§ˆé™åˆ¶ï¼ŒåŸºäºå®é™…æ—¶é—´`);
            console.log(`â° å°†åœ¨${PREVIEW_SECONDS}ç§’åæ˜¾ç¤ºæ”¯ä»˜é®ç½©`);
            previewTimer = setTimeout(() => {
              console.log('ğŸ”´ iframeé¢„è§ˆæ™‚é–“åˆ°é”é™åˆ¶ï¼ˆå¯¦éš›æ™‚é–“ï¼‰ï¼Œé¡¯ç¤ºæ”¯ä»˜é®ç½©');
              console.log('ğŸ¯ å³å°‡èª¿ç”¨showPayOverlay()å‡½æ•¸');
              showPayOverlay();
            }, PREVIEW_SECONDS * 1000);
            console.log('âœ… iframeè®¡æ—¶å™¨å·²è®¾ç½®æˆåŠŸï¼');
            console.log('ğŸ“Š è®¡æ—¶å™¨è¯¦æƒ…:', {
              timerID: previewTimer,
              delaySeconds: PREVIEW_SECONDS,
              delayMs: PREVIEW_SECONDS * 1000,
              startTime: new Date().toLocaleTimeString()
            });
          } else {
            // å¯¹äºVideo.jsæ’­æ”¾å™¨ï¼Œä½¿ç”¨åŸºäºè§†é¢‘æ’­æ”¾æ—¶é—´çš„æ£€æŸ¥æœºåˆ¶
            console.log(`ğŸ¬ Video.jsæ’­æ”¾å™¨å¯åŠ¨${PREVIEW_SECONDS}ç§’é¢„è§ˆé™åˆ¶ï¼ŒåŸºäºè§†é¢‘æ’­æ”¾æ—¶é—´`);
            forceCheckTimer = setInterval(() => {
              if(vjsPlayer && (vjsPlayer.currentTime() >= PREVIEW_SECONDS || totalWatchedTime >= PREVIEW_SECONDS)) {
                console.log('ğŸ”´ Video.jsé¢„è§ˆæ—¶é—´åˆ°è¾¾é™åˆ¶ - æ’­æ”¾æ—¶é—´:', vjsPlayer.currentTime().toFixed(1), 's, è§‚çœ‹æ—¶é—´:', totalWatchedTime.toFixed(1), 's');
                clearInterval(forceCheckTimer);
                showPayOverlay();
              }
            }, 500); // æ¯500msæ£€æŸ¥ä¸€æ¬¡ï¼Œæé«˜ç²¾åº¦
            console.log('âœ… Video.jsæ£€æŸ¥è®¡æ—¶å™¨å·²è®¾ç½®ï¼ŒTimer ID:', forceCheckTimer);
          }
        } else {
          console.log('âŒ ä¸æ»¡è¶³å¯åŠ¨é¢„è§ˆé™åˆ¶çš„æ¡ä»¶:', {
            needRestrict: needRestrict(),
            previewStarted: previewStarted,
            IS_VIP_VIDEO: IS_VIP_VIDEO,
            IS_PREMIUM_USER: IS_PREMIUM_USER,
            FORCE_VIP_TEST: typeof FORCE_VIP_TEST !== 'undefined' ? FORCE_VIP_TEST : 'undefined'
          });
        }
      }

      // å½“ HTML5 è§†é¢‘çœŸæ­£å¼€å§‹æ’­æ”¾åå†å¯åŠ¨è®¡æ—¶ï¼Œé¿å…ç”¨æˆ·æœªç‚¹å‡»æ’­æ”¾è®¡æ—¶å…ˆç»“æŸ
      vjsPlayer.on('play', ()=>{
        console.log('è§†é¢‘å¼€å§‹æ’­æ”¾ï¼ŒpreviewIsIframe:', previewIsIframe);
        if(!previewIsIframe){
          console.log('å¯åŠ¨é¢„è§ˆé™åˆ¶è®¡æ—¶');
          startPreviewCountdown();
        }
      });

      // é¢å¤–ç›‘å¬loadeddataäº‹ä»¶ï¼Œç¡®ä¿è§†é¢‘åŠ è½½åä¹Ÿå¯åŠ¨è®¡æ—¶
      vjsPlayer.on('loadeddata', ()=>{
        console.log('è§†é¢‘æ•°æ®åŠ è½½å®Œæˆï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦å¯åŠ¨é™åˆ¶');
        if(needRestrict() && !previewStarted && !previewIsIframe){
          console.log('é€šè¿‡loadeddataäº‹ä»¶å¯åŠ¨é¢„è§ˆé™åˆ¶è®¡æ—¶');
          startPreviewCountdown();
        }
      });

      // ç›‘å¬playingäº‹ä»¶ä½œä¸ºå¤‡ç”¨è§¦å‘
      vjsPlayer.on('playing', ()=>{
        console.log('è§†é¢‘æ­£åœ¨æ’­æ”¾ï¼Œæ£€æŸ¥è®¡æ—¶å™¨çŠ¶æ€');
        if(needRestrict() && !previewStarted && !previewIsIframe){
          console.log('é€šè¿‡playingäº‹ä»¶å¯åŠ¨é¢„è§ˆé™åˆ¶è®¡æ—¶');
          startPreviewCountdown();
        }
      });

      // é˜²æ­¢ç”¨æˆ·è°ƒæ•´æ’­æ”¾é€Ÿåº¦ç»•è¿‡é™åˆ¶
      vjsPlayer.on('ratechange', ()=>{
        if(needRestrict() && vjsPlayer.playbackRate() !== 1) {
          console.log('æ£€æµ‹åˆ°æ’­æ”¾é€Ÿåº¦å˜åŒ–ï¼Œé‡ç½®ä¸ºæ­£å¸¸é€Ÿåº¦');
          vjsPlayer.playbackRate(1);
        }
      });

      // é˜²æ­¢ç”¨æˆ·é€šè¿‡æ‹–æ‹½è¿›åº¦æ¡è·³è¿‡å†…å®¹
      vjsPlayer.on('seeking', ()=>{
        const seekTime = vjsPlayer.currentTime();
        if(needRestrict() && seekTime > PREVIEW_SECONDS) {
          console.log('æ£€æµ‹åˆ°ç”¨æˆ·å°è¯•è·³è¿‡é¢„è§ˆé™åˆ¶ï¼Œæ˜¾ç¤ºæ”¯ä»˜é®ç½©');
          showPayOverlay();
        }
      });

      async function getPreviewUrl(){
        const res = await fetch(`/api/video/${VIDEO_ID}/preview`);
        const j   = await res.json();
        return j.data.url;
      }

      async function getPlayUrl(){
        const res = await fetch(`/api/video/${VIDEO_ID}/play`,{
          headers:{ 'Authorization':'Bearer '+ (localStorage.authToken||'') }
        });
        if(res.status===403){
          return null; // æœªè´­ä¹°
        }
        const j = await res.json();
        return j.data && j.data.url;
      }

      function loadSource(url){
        if(url.includes('iframe.mediadelivery.net/embed')){
          const container = document.getElementById('playerContainer');
          // åˆ›å»ºå¹¶æ’å…¥ iframeï¼Œè€Œä¸æ›¿æ¢æ•´ä¸ªå®¹å™¨ï¼Œä»¥ä¿ç•™é®ç½©å±‚
          const iframe = document.createElement('iframe');
          iframe.src = url;
          // ç¡®ä¿è·¨åŸŸ iframe å‘é€ç«™ç‚¹æ¥æºï¼Œé…åˆ Bunny çš„ Allowed domains/Block empty referer
          iframe.setAttribute('referrerpolicy','origin-when-cross-origin');
          iframe.allow = 'accelerometer; gyroscope; autoplay; encrypted-media; picture-in-picture';
          iframe.allowFullscreen = true;
          iframe.style.position = 'absolute';
          iframe.style.top = '0';
          iframe.style.left = '0';
          iframe.style.width = '100%';
          iframe.style.height = '100%';
          iframe.style.border = 'none';

          // éšè—åŸç”Ÿ video å…ƒç´ ï¼Œé¿å…åŒæ—¶æ’­æ”¾
          playerEl.style.display = 'none';

          // å…ˆæ’å…¥ iframeï¼Œå†æŠŠ overlay ç½®äºæœ€ä¸Šå±‚
          container.appendChild(iframe);
          overlay.style.zIndex = '9999';
          container.appendChild(overlay);

          // è®°å½•çŠ¶æ€
          previewIsIframe = true;
          previewIframe   = iframe;

          // ç­‰å¾…iframeåŠ è½½å®Œæˆåå†å¯åŠ¨è®¡æ—¶å™¨
          console.log('ä½¿ç”¨iframeæ’­æ”¾ï¼Œç­‰å¾…åŠ è½½å®Œæˆåå¯åŠ¨é¢„è§ˆè®¡æ—¶');
          console.log('å½“å‰needRestrict()çŠ¶æ€:', needRestrict());
          console.log('å½“å‰previewStartedçŠ¶æ€:', previewStarted);
          
          // ç”±äºè·¨åŸŸiframeçš„onloadäº‹ä»¶å¯èƒ½ä¸å¯é ï¼Œç›´æ¥ä½¿ç”¨å»¶è¿Ÿå¯åŠ¨
          console.log('ğŸ¬ è·¨åŸŸiframeæ’­æ”¾å™¨ï¼Œä½¿ç”¨å»¶è¿Ÿå¯åŠ¨ç­–ç•¥');
          setTimeout(() => {
            console.log('ğŸ•’ 3ç§’å»¶è¿Ÿåˆ°è¾¾ï¼Œæ£€æŸ¥å¯åŠ¨æ¡ä»¶:', {
              previewStarted: previewStarted,
              needRestrict: needRestrict(),
              IS_VIP_VIDEO: IS_VIP_VIDEO,
              IS_PREMIUM_USER: IS_PREMIUM_USER
            });
            if(!previewStarted && needRestrict()) {
              console.log('â° å»¶è¿Ÿ3ç§’åå¯åŠ¨iframeé¢„è§ˆè®¡æ—¶');
              startPreviewCountdown();
            } else {
              console.log('âŒ ä¸æ»¡è¶³å¯åŠ¨æ¡ä»¶ï¼Œè·³è¿‡è®¡æ—¶å™¨è®¾ç½®');
            }
          }, 3000); // 3ç§’åå¯åŠ¨ï¼Œç»™iframeè¶³å¤Ÿçš„åŠ è½½å’Œæ’­æ”¾æ—¶é—´
          
          return;
        }

        const isHls = url.includes('.m3u8');
        const isDash = url.endsWith('.mpd');
        if(isDash){
          vjsPlayer.src({ src:url, type:'application/dash+xml' });
        }else if(isHls){
          vjsPlayer.src({ src:url, type:'application/x-mpegURL' });
        }else{
          vjsPlayer.src({ src:url, type:'video/mp4' });
        }
      }

      async function unlockVideo(){
        const res = await fetch(`/api/unlock/${VIDEO_ID}`,{
          method:'POST',
          headers:{
            'Authorization':'Bearer '+(localStorage.authToken||''),
            'Content-Type':'application/json'
          },
          body: JSON.stringify({ hoursValid: 72 })
        });
        const j = await res.json();
        return j.iframe; // å­—æ®µåä¸º iframe
      }

      async function init(){
        let url;

        // ç»Ÿä¸€èµ°å—æ§æ¥å£ï¼Œé¿å…ç›´æ¥ä½¿ç”¨ DEFAULT_PLAY_URL ç»•è¿‡ UA/é‰´æƒ
        if(IS_VIP_VIDEO || FORCE_VIP_TEST){
          if(IS_PREMIUM_USER){
            url = await getPlayUrl();
          } else {
            url = await getPreviewUrl();
          }
        } else if(IS_PAID_VIDEO){
          url = await getPlayUrl();
          if(!url){
            url = await getPreviewUrl();
          }
        } else {
          // å…è´¹è§†é¢‘ï¼šä»èµ°å—æ§ previewï¼ˆä¿æŒ UA æ ¡éªŒï¼‰ï¼Œé¢„ç•™åç«¯è¿”å›å®Œæ•´åœ°å€
          url = await getPreviewUrl();
          if(!url){ url = DEFAULT_PLAY_URL; }
        }

        // ä»ä¼˜å…ˆä½¿ç”¨ Bunny iframeï¼ˆåµŒå…¥æ’­æ”¾å™¨ä¼šè‡ªåŠ¨å¯¹åˆ†ç‰‡ç­¾åï¼‰ï¼›æˆ‘ä»¬å·²è®¾ç½® referrerpolicy ä»¥æ»¡è¶³ Allowed domains/Block empty referrer

        if(!url){
          console.error('æ— æ³•è·å–æ’­æ”¾åœ°å€');
          return;
        }

        loadSource(url);
        // å…ƒæ•°æ®åŠ è½½åè‡ªåŠ¨æ’­æ”¾é™éŸ³
        vjsPlayer.ready(()=>{
          console.log('Video.jsæ’­æ”¾å™¨å‡†å¤‡å°±ç»ª');
          if(!needRestrict()){
            console.log('æ— éœ€é™åˆ¶ï¼Œæ­£å¸¸æ’­æ”¾');
            vjsPlayer.muted(true);
            vjsPlayer.play().catch(()=>{});
          } else {
            // å¯¹äºéœ€è¦é™åˆ¶çš„è§†é¢‘ï¼Œä¹Ÿå…è®¸æ’­æ”¾ä½†ä¼šåœ¨150ç§’åæš‚åœ
            console.log('éœ€è¦é™åˆ¶çš„è§†é¢‘ï¼Œå¯åŠ¨æ’­æ”¾å’Œè®¡æ—¶');
            vjsPlayer.muted(true);
            vjsPlayer.play().then(() => {
              console.log('è§†é¢‘æ’­æ”¾æˆåŠŸï¼Œå¼ºåˆ¶å¯åŠ¨è®¡æ—¶å™¨');
              if(!previewStarted) {
                startPreviewCountdown();
              }
            }).catch((e) => {
              console.log('è§†é¢‘æ’­æ”¾å¤±è´¥ï¼Œä½†ä»å¯åŠ¨è®¡æ—¶å™¨:', e);
              if(!previewStarted) {
                startPreviewCountdown();
              }
            });
          }
        });
      }

      buyBtn.addEventListener('click', async ()=>{
        // è‹¥ä¸ºä¼šå‘˜è§†é¢‘ï¼Œåˆ™è·³è½¬ä¸ªäººä¸­å¿ƒé¡µé¢ï¼ˆå¯ä½¿ç”¨VIPè´­ä¹°å¼¹çª—ï¼‰
        if(IS_VIP_VIDEO || FORCE_VIP_TEST){
          console.log('ğŸ¯ ä¼šå‘˜è§†é¢‘ï¼šè·³è½¬åˆ°ä¸ªäººä¸­å¿ƒé¡µé¢');
          location.href = '/user';
          return;
        }
        // ä»˜è´¹è§†é¢‘è´­ä¹°æµç¨‹
        if(!IS_LOGIN){ alert('è¯·å…ˆç™»å½•'); return; }
        try{
          const iframeUrl = await unlockVideo();
          if(iframeUrl){
            hasPurchase = true;
            if(previewTimer){ clearTimeout(previewTimer); previewTimer = null; }
            if(forceCheckTimer){ clearInterval(forceCheckTimer); forceCheckTimer = null; }
            if(previewIsIframe && previewIframe){ previewIframe.remove(); previewIframe = null; }
            overlay.style.display = 'none';

            const finalUrl = iframeUrl.includes('?') ? `${iframeUrl}&autoplay=true&muted=false&playsinline=true` : `${iframeUrl}?autoplay=true&muted=false&playsinline=true`;

            const container = document.getElementById('playerContainer');
            container.innerHTML = '';
            playerEl.style.display = 'none';
            previewIsIframe = false;
            loadSource(finalUrl);
          }else{
            alert('è§£é”å¤±è´¥');
          }
        }catch(e){ console.error(e); alert('è´­ä¹°å¤±è´¥'); }
      });

      init();

      // å¼•å…¥è§†é¢‘é¢„è§ˆå¤„ç†è„šæœ¬ - ç›´æ¥å¤åˆ¶ä¸»é¡µçš„é€»è¾‘
      document.addEventListener('DOMContentLoaded', () => {
        // é¦–å…ˆä¸ºç›¸å…³æ¨èè§†é¢‘å¡ç‰‡è®¾ç½®__data__å±æ€§
        const relatedVideosData = JSON.parse(document.getElementById('related-videos-data').textContent || '[]');
        const videoCards = document.querySelectorAll('.video-card');
        videoCards.forEach((card, index) => {
          if (relatedVideosData[index]) {
            card.__data__ = relatedVideosData[index];
          }
        });

        function applyPreviewAnimation(){
          document.querySelectorAll('.video-card').forEach(card => {
            const videoData = card.__data__ || {};
            const img = card.querySelector('.video-thumbnail img');
            if(!img) return;

            const thumbDiv = card.querySelector('.video-thumbnail');
            let p = thumbDiv?.dataset.preview || (videoData && videoData.previewUrl) || '';
            const imgFallback = thumbDiv?.dataset.image || (videoData && videoData.previewImage) || '';
            if(!p) return;

            if(/\.(mp4|webm)$/i.test(p)){
              const v = document.createElement('video');
              v.muted = true;
              v.loop = true;
              v.autoplay = true;
              v.playsInline = true;
              v.setAttribute('playsinline','');
              v.setAttribute('webkit-playsinline','');
              v.setAttribute('muted','');
              v.style.width = '100%';
              v.style.height = '100%';
              v.style.objectFit = 'cover';
              v.style.background = 'transparent';

              // å°è¯• webm ä¸ mp4 åŒæº
              const source1 = document.createElement('source');
              source1.src = p;
              source1.type = p.endsWith('.webm') ? 'video/webm' : 'video/mp4';
              const alt = p.endsWith('.webm') ? p.replace('.webm','.mp4') : p.replace('.mp4','.webm');
              const source2 = document.createElement('source');
              source2.src = alt;
              source2.type = alt.endsWith('.webm') ? 'video/webm' : 'video/mp4';
              v.appendChild(source1);
              v.appendChild(source2);
              v.src = p; // è®¾ç½®é¦–é€‰æºï¼ŒSafari éœ€è¦

              // å‡ºé”™æ—¶å›é€€åˆ°å›¾ç‰‡
              v.onerror = ()=>{ if(imgFallback){ img.src = imgFallback; }
              };

              img.replaceWith(v);
            }else{
              img.src = p;
            }
          });
        }

        applyPreviewAnimation();
      });
    </script>
</body>
</html>