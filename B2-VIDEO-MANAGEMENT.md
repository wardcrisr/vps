# B2 视频管理系统使用说明

## 功能概述

本系统集成了 Backblaze B2 云存储服务，为管理员提供了完整的视频文件管理功能，包括视频的上传、删除、列举和管理。

## 主要特性

- ✅ **云存储集成**: 使用 Backblaze B2 作为主要存储后端
- ✅ **文件管理**: 支持视频文件的增删改查操作
- ✅ **大文件支持**: 支持最大 500MB 的视频文件上传
- ✅ **进度监控**: 实时显示上传进度
- ✅ **存储统计**: 展示存储使用情况和文件统计
- ✅ **权限控制**: 仅管理员可访问和操作
- ✅ **错误处理**: 完善的错误提示和异常处理

## 系统架构

### 后端接口

#### 1. B2 视频列表接口
- **URL**: `GET /api/admin/b2-videos`
- **功能**: 获取 B2 存储中的所有视频文件
- **参数**: 
  - `prefix` (可选): 文件前缀过滤
  - `limit` (可选): 返回数量限制，默认 100
- **响应**: 包含视频文件列表、文件信息和统计数据

#### 2. 视频上传接口
- **URL**: `POST /api/admin/b2-videos/upload`
- **功能**: 上传视频文件到 B2 存储
- **参数**: 
  - `video` (文件): 视频文件 (最大 500MB)
  - `title` (字符串): 视频标题
  - `description` (可选): 视频描述
- **响应**: 上传成功后返回文件信息和下载链接

#### 3. 视频删除接口
- **URL**: `DELETE /api/admin/b2-videos/:fileName`
- **功能**: 从 B2 存储中删除指定视频文件
- **参数**: `fileName` - 文件名
- **响应**: 删除操作结果

#### 4. 下载链接生成接口
- **URL**: `GET /api/admin/b2-videos/:fileName/download`
- **功能**: 生成临时下载链接
- **参数**: 
  - `fileName` - 文件名
  - `userId` (可选): 用户ID
- **响应**: 带签名的临时下载链接

#### 5. 存储统计接口
- **URL**: `GET /api/admin/b2-videos/stats/storage`
- **功能**: 获取 B2 存储使用统计
- **响应**: 连接状态、文件数量、存储用量等统计信息

### 前端组件

#### B2VideoManager 组件
位置: `src/pages/B2VideoManager.jsx`

**主要功能**:
- 📊 存储状态监控面板
- 📤 视频文件上传（支持进度显示）
- 📋 视频文件列表展示
- 🗑️ 视频文件删除
- 🔗 下载链接复制
- 🔄 列表刷新

**技术特点**:
- 使用 React Hooks 进行状态管理
- 集成 XMLHttpRequest 实现上传进度监控
- 响应式设计，支持各种屏幕尺寸
- 完善的错误处理和用户反馈

## 安装与配置

### 1. 环境变量配置

在项目根目录的 `.env` 文件中添加以下配置:

```env
# B2 存储配置
B2_ENDPOINT=s005.backblazeb2.com
B2_APPLICATION_KEY_ID=your_key_id
B2_APPLICATION_KEY=your_application_key
B2_BUCKET_NAME=your_bucket_name

# CDN 配置 (可选)
CDN_BASE_URL=https://your-cdn-domain.com
```

### 2. 依赖安装

确保已安装以下 npm 包:

```bash
npm install aws-sdk multer jsonwebtoken
```

### 3. 目录结构

确保以下目录存在:
```
content-distribution/
├── uploads/
│   └── temp/          # 临时文件上传目录
├── src/
│   ├── routes/
│   │   └── b2Videos.js    # B2 视频管理路由
│   ├── pages/
│   │   └── B2VideoManager.jsx  # 前端管理组件
│   └── services/
│       └── b2Storage-simple.js  # B2 存储服务
```

## 使用指南

### 管理员访问

1. **登录管理员账户**
   - 访问 `/admin` 页面
   - 使用管理员凭据登录

2. **访问 B2 视频管理**
   - 在左侧菜单中点击"B2 视频管理"
   - 或直接访问 `/admin/b2-videos`

### 视频管理操作

#### 上传视频
1. 点击"选择视频文件"按钮
2. 选择要上传的视频文件 (最大 500MB)
3. 填写视频标题 (必填)
4. 填写视频描述 (可选)
5. 点击"上传到 B2"按钮
6. 等待上传完成，可查看实时进度

#### 管理视频
- **查看列表**: 自动显示 B2 存储中的所有视频文件
- **复制链接**: 点击复制按钮获取下载链接
- **打开视频**: 点击外链按钮在新窗口中查看视频
- **删除视频**: 点击删除按钮永久删除文件

#### 存储监控
- **连接状态**: 显示 B2 存储连接状态
- **视频总数**: 显示存储中的视频文件数量
- **存储用量**: 显示已使用的存储空间
- **存储桶**: 显示当前使用的 B2 存储桶名称

## 测试与验证

### 运行测试脚本

```bash
# 启动应用服务器
npm run dev

# 在另一个终端运行测试
node test-b2-video-management.js
```

### 测试覆盖范围

测试脚本将验证以下功能:
- ✅ 管理员登录认证
- ✅ B2 存储连接状态
- ✅ 视频列表获取
- ✅ 存储统计信息
- ✅ 视频文件上传 (如果提供测试文件)
- ✅ 下载链接生成
- ✅ 视频文件删除

### 手动测试步骤

1. **准备测试环境**
   ```bash
   # 确保服务器运行
   npm run dev
   
   # 确保 B2 配置正确
   # 检查环境变量是否设置
   ```

2. **测试前端界面**
   - 访问 `http://localhost:3000/admin`
   - 登录管理员账户
   - 点击"B2 视频管理"菜单
   - 验证页面加载和数据显示

3. **测试上传功能**
   - 选择一个小于 500MB 的视频文件
   - 填写标题并上传
   - 观察上传进度
   - 验证上传成功提示

4. **测试管理功能**
   - 验证视频在列表中显示
   - 测试复制下载链接
   - 测试删除功能

## 故障排除

### 常见问题

1. **B2 连接失败**
   - 检查环境变量配置
   - 验证 B2 API 密钥权限
   - 确认存储桶名称正确

2. **上传失败**
   - 检查文件大小限制 (500MB)
   - 验证文件类型 (仅支持视频文件)
   - 检查临时目录权限

3. **列表显示异常**
   - 检查 B2 存储桶权限
   - 验证 CORS 配置
   - 查看服务器日志

### 日志查看

应用会在控制台输出详细的操作日志:
```
✅ Backblaze B2 (S3 API) 已连接
📹 获取B2视频列表...
🚀 开始上传视频到B2: example.mp4
✅ 视频上传成功: example.mp4 -> video/2024/01/example-1234567890-abc123.mp4
```

## 安全注意事项

1. **权限控制**: 仅管理员可访问 B2 视频管理功能
2. **文件验证**: 严格验证上传文件类型和大小
3. **令牌安全**: 下载链接使用 JWT 签名，具有时效性
4. **CORS 配置**: 适当配置 B2 存储桶的 CORS 政策

## 技术规格

- **支持的视频格式**: MP4, AVI, MOV, WMV, FLV, WebM, MKV
- **最大文件大小**: 500MB
- **下载链接有效期**: 24小时
- **存储后端**: Backblaze B2 (S3 兼容 API)
- **前端框架**: React 18 + Bootstrap 5
- **后端框架**: Express.js + MongoDB

## 更新历史

### v1.0.0 (2024-01-XX)
- ✅ 初始版本发布
- ✅ 基础 B2 集成
- ✅ 视频上传/删除功能
- ✅ 管理员界面
- ✅ 存储统计监控 