# 老金优品 - 上传功能修复指南

## 问题诊断

上传失败的原因：
1. ❌ **缺少 multer 依赖** - 文件上传库
2. ❌ **B2存储服务依赖问题** - aws-sdk 等包缺失
3. ❌ **服务器可能使用旧版本代码**

## 🚀 立即修复步骤

### 步骤1：切换到项目目录
```bash
cd /root/content-distribution
```

### 步骤2：安装必要依赖
```bash
npm install multer --save
```

### 步骤3：停止当前服务器
```bash
# 查找并停止所有 node 进程
pkill -f "node src/app"

# 确认进程已停止
ps aux | grep node
```

### 步骤4：启动简化版服务器
```bash
# 使用不依赖B2的版本
node src/app-no-b2.js &

# 或者在后台运行并保存日志
nohup node src/app-no-b2.js > upload-server.log 2>&1 &
```

### 步骤5：验证服务器状态
```bash
# 检查进程
ps aux | grep "node src/app-no-b2.js"

# 查看日志
tail -f upload-server.log
```

## 📋 预期输出

成功启动后，应该看到：
```
✅ MongoDB 已连接
🚀 Server running at http://localhost:3000
📁 Upload directory: /root/content-distribution/uploads
✅ 简化版应用启动成功（本地存储模式）
```

## 🧪 测试上传功能

1. **访问网站**: http://fulijix.com
2. **点击上传按钮**
3. **选择一个小图片文件**（建议先测试小文件）
4. **观察上传结果**

成功上传后应该显示：
- ✅ "成功上传 1 个文件！"
- 文件保存在 `/root/content-distribution/uploads/` 目录

## 🔧 故障排除

### 如果上传仍然失败：

1. **检查服务器日志**：
   ```bash
   tail -20 upload-server.log
   ```

2. **检查上传目录权限**：
   ```bash
   ls -la uploads/
   chmod 777 uploads/
   ```

3. **手动测试依赖**：
   ```bash
   node -e "console.log(require('multer'))"
   ```

4. **重新安装所有依赖**：
   ```bash
   rm -rf node_modules
   npm install
   ```

### 如果MongoDB连接失败：
```bash
# 启动MongoDB服务
sudo systemctl start mongod
# 或
sudo service mongodb start
```

## 📊 功能特性

简化版服务器支持：
- ✅ **文件上传** - 图片和视频
- ✅ **本地存储** - 保存在服务器磁盘
- ✅ **数据库记录** - MongoDB存储文件信息
- ✅ **分类浏览** - 按类型查看文件
- ✅ **搜索功能** - 查找上传的内容
- ⚠️ **暂时禁用** - B2云存储（避免依赖问题）

## 🎯 下一步优化

上传功能正常后，可以考虑：
1. 重新启用B2云存储
2. 添加图片压缩功能
3. 实现批量上传
4. 添加上传进度显示

---

**注意**: 这是临时修复方案，专注解决上传问题。一旦上传正常工作，我们可以逐步重新集成其他功能。 