# 老金优品 - 用户认证系统

## 系统概览

本系统实现了完整的用户注册登录功能和管理员后台管理，包括：

### 用户功能
- ✅ 用户注册（邮箱 + 密码）
- ✅ 用户登录（邮箱 + 密码）
- ✅ 个人中心（用户资料管理）
- ✅ 密码修改
- ✅ VIP会员系统
- ✅ 个人信息修改（昵称、QQ、个人介绍）

### 管理员功能
- ✅ 管理员后台界面
- ✅ 用户列表管理
- ✅ 用户角色设置（普通用户/VIP/管理员）
- ✅ 用户删除（保护管理员账户）
- ✅ 用户搜索筛选
- ✅ 统计数据展示
- ✅ 批量用户操作

## 快速开始

### 1. 安装依赖
```bash
cd content-distribution
npm install bcryptjs express-validator
```

### 2. 创建管理员账户
```bash
node create-admin.js
```

系统将创建默认管理员账户：
- 邮箱: `admin@laojinyoupin.com`
- 密码: `admin123456`

### 3. 启动服务器
```bash
npm start
# 或
node src/app.js
```

### 4. 访问系统

**用户端：**
- 首页：http://localhost:3000
- 用户登录：http://localhost:3000/api/auth/login
- 用户注册：http://localhost:3000/api/auth/register
- 个人中心：http://localhost:3000/api/auth/profile

**管理员端：**
- 管理后台：http://localhost:3000/api/admin/dashboard

## 界面展示

### 用户登录界面
![用户登录](./screenshots/login.png)
- 现代化设计
- 响应式布局
- 表单验证
- 加载状态提示

### 用户注册界面
![用户注册](./screenshots/register.png)
- 密码确认验证
- 实时错误提示
- 自动跳转登录

### 个人中心界面
![个人中心](./screenshots/profile.png)
- 参照图片中的设计风格
- 侧边栏导航
- 用户资料编辑
- 密码修改功能
- VIP状态显示

### 管理员后台
![管理后台](./screenshots/admin.png)
- 用户统计数据
- 用户列表管理
- 搜索筛选功能
- 批量操作工具

## API 接口

### 认证相关 `/api/auth`

#### 用户注册
```http
POST /api/auth/register
Content-Type: application/json

{
  "username": "用户名",
  "email": "email@example.com",
  "password": "密码"
}
```

#### 用户登录
```http
POST /api/auth/login
Content-Type: application/json

{
  "email": "email@example.com",
  "password": "密码"
}

# 响应
{
  "success": true,
  "message": "登录成功",
  "token": "JWT_TOKEN",
  "user": {
    "id": "用户ID",
    "username": "用户名",
    "email": "邮箱",
    "role": "角色",
    "isPremium": false
  }
}
```

#### 更新用户资料
```http
POST /api/auth/update-profile
Authorization: Bearer JWT_TOKEN
Content-Type: application/json

{
  "displayName": "显示昵称",
  "qq": "QQ号",
  "bio": "个人介绍"
}
```

#### 修改密码
```http
POST /api/auth/change-password
Authorization: Bearer JWT_TOKEN
Content-Type: application/json

{
  "currentPassword": "当前密码",
  "newPassword": "新密码"
}
```

### 管理员相关 `/api/admin`

#### 获取用户列表
```http
GET /api/admin/users?page=1&limit=10&search=关键词&role=用户角色
Authorization: Bearer JWT_TOKEN
```

#### 更新用户信息
```http
PUT /api/admin/users/:userId
Authorization: Bearer JWT_TOKEN
Content-Type: application/json

{
  "role": "user|vip|admin",
  "isPremium": true,
  "premiumExpiry": "2024-12-31T23:59:59.000Z",
  "dailyDownloadLimit": 10
}
```

#### 删除用户
```http
DELETE /api/admin/users/:userId
Authorization: Bearer JWT_TOKEN
```

#### 获取统计数据
```http
GET /api/admin/stats
Authorization: Bearer JWT_TOKEN
```

## 数据模型

### 用户模型 (User)
```javascript
{
  username: String,      // 用户名
  email: String,         // 邮箱
  password: String,      // 密码哈希
  role: String,          // 角色: user|vip|admin
  displayName: String,   // 显示昵称
  avatar: String,        // 头像URL
  qq: String,           // QQ号
  bio: String,          // 个人介绍
  isPremium: Boolean,   // 是否VIP
  premiumExpiry: Date,  // VIP过期时间
  downloadCount: Number,        // 当日下载数
  dailyDownloadLimit: Number,   // 每日下载限制
  totalDownloads: Number,       // 总下载数
  joinDate: Date,              // 注册时间
  lastLogin: Date              // 最后登录时间
}
```

## 权限系统

### 用户角色
- **user**: 普通用户，基础下载权限
- **vip**: VIP用户，高级下载权限
- **admin**: 管理员，完全访问权限

### 权限中间件
- `authenticateToken`: JWT token验证
- `optionalAuth`: 可选认证（不强制登录）
- `requireAdmin`: 需要管理员权限
- `requireVIP`: 需要VIP权限

## 安全特性

1. **密码加密**: 使用bcrypt哈希存储
2. **JWT认证**: 7天有效期的token
3. **权限验证**: 中间件保护敏感操作
4. **管理员保护**: 防止删除管理员账户
5. **输入验证**: express-validator数据验证

## 自定义配置

### 环境变量配置
在 `src/config/production.env` 中设置：
```
MONGO_URI=mongodb://127.0.0.1:27017/contentdb
JWT_SECRET=your_super_secret_key_here
```

### 修改默认管理员
编辑 `create-admin.js` 文件修改默认管理员信息。

## 故障排除

### 常见问题

1. **数据库连接失败**
   - 检查MongoDB是否启动
   - 验证MONGO_URI配置

2. **Token无效错误**
   - 检查JWT_SECRET配置
   - 确认token格式正确

3. **权限被拒绝**
   - 确认用户角色设置
   - 检查中间件配置

### 调试模式
启动时添加调试信息：
```bash
DEBUG=* node src/app.js
```

## 升级指南

### 从基础版本升级
1. 运行 `create-admin.js` 创建管理员
2. 更新前端调用，使用新的API路径
3. 添加JWT token到请求头

### 数据迁移
如果有现有用户数据，可以运行以下脚本添加新字段：
```javascript
// 为现有用户添加新字段
db.users.updateMany({}, {
  $set: {
    displayName: "",
    avatar: "",
    qq: "",
    bio: "",
    isPremium: false,
    dailyDownloadLimit: 5
  }
});
```

## 技术支持

如有问题，请检查：
1. 控制台错误信息
2. 网络请求状态
3. 数据库连接状态
4. JWT token有效性

---

**开发完成日期**: 2024年12月

**版本**: v1.0.0

**作者**: AI Assistant 